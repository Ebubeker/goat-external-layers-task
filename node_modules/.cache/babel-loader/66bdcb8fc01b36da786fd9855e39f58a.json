{"remainingRequest":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/babel-loader/lib/index.js!/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/vuetify-loader/lib/loader.js??ref--19-0!/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/cache-loader/dist/cjs.js??ref--0-0!/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/ebubeker/Desktop/programming/work tasks/goat/app/client/src/components/viewer/mapillary/Mapillary.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/src/components/viewer/mapillary/Mapillary.vue","mtime":1657636289859},{"path":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/cache-loader/dist/cjs.js","mtime":1657636581841},{"path":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/babel-loader/lib/index.js","mtime":1657636581481},{"path":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/vuetify-loader/lib/loader.js","mtime":1657636582513},{"path":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/cache-loader/dist/cjs.js","mtime":1657636581841},{"path":"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/vue-loader/lib/index.js","mtime":1657636582549}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport _defineProperty from \"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"/home/ebubeker/Desktop/programming/work tasks/goat/app/client/node_modules/@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport \"core-js/modules/es6.regexp.to-string\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { Viewer } from \"mapillary-js\"; //Ol imports\n\nimport OlVectorLayer from \"ol/layer/Vector\";\nimport OlVectorSource from \"ol/source/Vector\";\nimport OlPoint from \"ol/geom/Point\";\nimport OlVectorTileLayer from \"ol/layer/VectorTile\";\nimport OlVectorTileSource from \"ol/source/VectorTile\";\nimport OlOverlay from \"ol/Overlay\";\nimport { createXYZ } from \"ol/tilegrid\";\nimport { fromLonLat } from \"ol/proj\";\nimport OlFeature from \"ol/Feature\";\nimport MVT from \"ol/format/MVT\";\nimport { unByKey } from \"ol/Observable\";\nimport { transformExtent } from \"ol/proj\"; // import { toLonLat } from \"ol/proj\";\n// import axios from \"axios\";\n//Style and map object import\n\nimport { mapillaryStyleDefs } from \"../../../style/OlStyleDefs\";\nimport { Mapable } from \"../../../mixins/Mapable\";\nimport { mapFields } from \"vuex-map-fields\"; // Image preview component import (enabled on hover)\n\nimport MapillaryImagePreview from \"./controls/MapillaryImagePreview\";\nimport \"mapillary-js/dist/mapillary.css\";\nimport { debounce } from \"../../../utils/Helpers\";\nexport default {\n  name: \"app-mapillary\",\n  components: {\n    \"mapillary-image-preview\": MapillaryImagePreview\n  },\n  props: {\n    accessToken: {\n      type: String,\n      required: false,\n      default: \"MLY|4945732362162775|a3872ee8a2b737be51db110cdcdea3d4\"\n    },\n    baseLayerExtent: {\n      type: Array,\n      required: false\n    }\n  },\n  data: function data() {\n    return {\n      // Preview Image url\n      previewImageUrl: \"\",\n      // Mapillary viewer\n      mapillary: null,\n      // Features\n      highlightFeature: null,\n      pointFeature: null,\n      // Layers\n      movePointLayer: null,\n      baseOverlayerLayer: null,\n      hoverHighlightLayer: null,\n      // Listener keys\n      mapClickListenerKey: null,\n      mapHoverListenerKey: null,\n      // Overlays\n      imagePreviewOverlay: null\n    };\n  },\n  mixins: [Mapable],\n  mounted: function mounted() {\n    var _this = this;\n\n    var container = document.getElementById(\"mapillary-container\");\n    var mapCenter = this.map.getView().getCenter();\n    var searchBounds = [mapCenter[0] - 1500, mapCenter[1] - 1500, mapCenter[0] + 1500, mapCenter[1] + 1500];\n    var extent = transformExtent(searchBounds, \"EPSG:3857\", \"EPSG:4326\");\n    fetch(\"https://graph.mapillary.com/images?fields=id,sequence&bbox=\".concat(extent.toString(), \"&limit=1\"), {\n      headers: {\n        Authorization: \"OAuth \" + this.accessToken\n      }\n    }).then(function (response) {\n      return response.json();\n    }).then(function (response) {\n      _this.isMapillaryBtnDisabled = false;\n\n      if (Array.isArray(response.data) && response.data.length > 0) {\n        var startImageId = response.data[0].id;\n        mapillaryStyleDefs.activeSequence = response.data[0].sequence;\n        console.log(response.data[0]);\n        _this.mapillary = new Viewer({\n          accessToken: _this.accessToken,\n          container: container,\n          imageId: startImageId,\n          component: {\n            cover: false\n          }\n        });\n        _this.isMapillaryBtnDisabled = false;\n        window.addEventListener(\"resize\", _this.resize());\n\n        _this.createBaseOverlayLayer();\n\n        _this.mapillary.on(\"image\", _this.mapillaryChanged);\n\n        _this.createFeatureOverlay();\n\n        _this.createImagePreviewOverlay();\n\n        _this.createMovePointLayer();\n\n        _this.createHoverHighlightLayer();\n\n        _this.addInteractions();\n\n        _this.mapClickListenerKey = _this.map.on(\"click\", _this.onClick);\n\n        _this.$nextTick(function () {\n          _this.resize();\n        });\n      }\n    }).catch(function () {\n      _this.isMapillaryBtnDisabled = false;\n    });\n  },\n  methods: {\n    /**\n     * Overlay style\n     */\n    createFeatureOverlay: function createFeatureOverlay() {\n      this.featureOverlay = new OlVectorLayer({\n        source: new OlVectorSource(),\n        map: this.map,\n        style: [mapillaryStyleDefs.wifiStyle, mapillaryStyleDefs.circleSolidStyle]\n      });\n    },\n\n    /**\n     * Image preview overlay\n     */\n\n    /**\n     * Show popup for the get info module.\n     */\n    createImagePreviewOverlay: function createImagePreviewOverlay() {\n      this.imagePreviewOverlay = new OlOverlay({\n        element: this.$refs.imagePreview.$el,\n        autoPan: false,\n        autoPanMargin: 40,\n        autoPanAnimation: {\n          duration: 250\n        }\n      });\n      this.map.addOverlay(this.imagePreviewOverlay);\n    },\n\n    /**\n     * Radar point layer\n     */\n    createMovePointLayer: function createMovePointLayer() {\n      this.pointFeature = new OlFeature({\n        geometry: null\n      });\n      this.pointFeature.setStyle([mapillaryStyleDefs.wifiStyle, mapillaryStyleDefs.circleSolidStyle]);\n      this.movePointLayer = new OlVectorLayer({\n        zIndex: 10,\n        source: new OlVectorSource({\n          features: [this.pointFeature]\n        })\n      });\n      this.map.addLayer(this.movePointLayer);\n    },\n\n    /**\n     * Overlay layer (sequences, images)\n     */\n    createBaseOverlayLayer: function createBaseOverlayLayer() {\n      this.baseOverlayerLayer = new OlVectorTileLayer({\n        name: \"mapillaryBaseOverlay\",\n        renderMode: \"image\",\n        source: new OlVectorTileSource({\n          attributions: \"© <a href='https://www.mapillary.com/'> <img src='./static/layer-styles/assets/icons/_backgroundLayers/mapillary.svg' width='12px' height='12px'> Mapillary</a>\",\n          format: new MVT(),\n          tileGrid: createXYZ({\n            maxZoom: 14\n          }),\n          tilePixelRatio: 16,\n          opacity: 0.7,\n          url: \"https://tiles.mapillary.com/maps/vtp/mly1_computed_public/2/{z}/{x}/{y}?access_token=\".concat(this.accessToken)\n        }),\n        style: mapillaryStyleDefs.baseOverlayStyle(this.map)\n      });\n\n      if (this.baseLayerExtent) {\n        this.baseOverlayerLayer.setExtent(this.baseLayerExtent);\n      }\n\n      this.map.addLayer(this.baseOverlayerLayer);\n    },\n\n    /**\n     * Create hover highlight layers\n     */\n    createHoverHighlightLayer: function createHoverHighlightLayer() {\n      this.hoverHighlightLayer = new OlVectorLayer({\n        zIndex: 20,\n        name: \"mapillaryHighlightLayer\",\n        source: new OlVectorSource(),\n        style: mapillaryStyleDefs.highlightStyle\n      });\n      this.map.addLayer(this.hoverHighlightLayer);\n    },\n\n    /**\n     * Overlay layer interactions\n     */\n    addInteractions: function () {\n      var _addInteractions = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee2() {\n        var _this2 = this;\n\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                this.mapHoverListenerKey = this.map.on(\"pointermove\", debounce(\n                /*#__PURE__*/\n                function () {\n                  var _ref = _asyncToGenerator(\n                  /*#__PURE__*/\n                  regeneratorRuntime.mark(function _callee(evt) {\n                    var features, feature, imageRequestUrl;\n                    return regeneratorRuntime.wrap(function _callee$(_context) {\n                      while (1) {\n                        switch (_context.prev = _context.next) {\n                          case 0:\n                            features = _this2.map.getFeaturesAtPixel(evt.pixel, {\n                              layerFilter: function layerFilter(candidate) {\n                                if (candidate.get(\"name\") === \"mapillaryBaseOverlay\") {\n                                  return true;\n                                }\n\n                                return false;\n                              }\n                            });\n                            features = features.filter(function (feature) {\n                              return feature.get(\"layer\") === \"image\";\n                            });\n\n                            _this2.hoverHighlightLayer.getSource().clear();\n\n                            if (features.length > 0 && features[0].get(\"id\")) {\n                              _this2.imagePreviewOverlay.setPosition(features[0].getFlatCoordinates());\n\n                              feature = new OlFeature({\n                                geometry: new OlPoint(features[0].getFlatCoordinates())\n                              });\n                              feature.setProperties(features[0].getProperties());\n\n                              _this2.hoverHighlightLayer.getSource().addFeature(feature);\n\n                              _this2.map.getTarget().style.cursor = \"pointer\";\n                              imageRequestUrl = \"https://graph.mapillary.com/\".concat(features[0].get(\"id\"), \"?fields=id,captured_at,compass_angle,sequence,geometry,thumb_256_url\");\n                              fetch(imageRequestUrl, {\n                                headers: {\n                                  Authorization: \"OAuth \" + _this2.accessToken\n                                }\n                              }).then(function (response) {\n                                return response.json();\n                              }).then(function (response) {\n                                _this2.previewImageUrl = response.thumb_256_url;\n                              });\n                            } else {\n                              _this2.previewImageUrl = \"\";\n\n                              _this2.imagePreviewOverlay.setPosition(undefined);\n\n                              _this2.map.getTarget().style.cursor = \"\";\n                            }\n\n                          case 4:\n                          case \"end\":\n                            return _context.stop();\n                        }\n                      }\n                    }, _callee);\n                  }));\n\n                  return function (_x) {\n                    return _ref.apply(this, arguments);\n                  };\n                }(), 50));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function addInteractions() {\n        return _addInteractions.apply(this, arguments);\n      }\n\n      return addInteractions;\n    }(),\n\n    /**\n     * Click event handler\n     */\n    onClick: function onClick(evt) {\n      var _this3 = this;\n\n      this.hoverHighlightLayer.getSource().clear();\n      var feature = this.map.forEachFeatureAtPixel(evt.pixel, function (feature) {\n        return feature;\n      }, {\n        layerFilter: function layerFilter(layer) {\n          return layer === _this3.baseOverlayerLayer;\n        },\n        hitTolerance: 5\n      });\n\n      if (feature) {\n        if (feature.get(\"layer\") === \"sequence\") {\n          return;\n        }\n\n        var bearing = feature.get(\"compass_angle\");\n        this.mapillary.moveTo(feature.get(\"id\"));\n        this.featureOverlay.setStyle(mapillaryStyleDefs.updateBearingStyle(bearing));\n        mapillaryStyleDefs.activeSequence = feature.get(\"sequence_id\");\n      } else {\n        return;\n      } //Update layer\n\n\n      this.baseOverlayerLayer.changed();\n    },\n\n    /**\n     * Mapillary changed event handler\n     */\n    mapillaryChanged: function mapillaryChanged(evt) {\n      if (this.featureOverlay.getVisible()) {\n        this.featureOverlay.setVisible(false);\n      }\n\n      var image = evt.image;\n      var lonLat = new fromLonLat([image.lngLat.lng, image.lngLat.lat]);\n      this.map.getView().animate({\n        center: lonLat,\n        duration: 400\n      });\n\n      if (this.pointFeature.getGeometry() === null) {\n        this.pointFeature.setGeometry(new OlPoint(lonLat));\n      } else {\n        this.pointFeature.getGeometry().setCoordinates(lonLat);\n      }\n\n      this.pointFeature.setStyle(mapillaryStyleDefs.updateBearingStyle(image.compassAngle));\n    },\n\n    /**\n     * Resize method\n     */\n    resize: function resize() {\n      this.mapillary.resize();\n    }\n  },\n  computed: _objectSpread({}, mapFields(\"map\", {\n    isMapillaryBtnDisabled: \"isMapillaryBtnDisabled\",\n    isMapillaryButtonActive: \"isMapillaryButtonActive\"\n  })),\n  destroyed: function destroyed() {\n    unByKey(this.mapClickListenerKey);\n    unByKey(this.mapHoverListenerKey);\n    this.map.removeLayer(this.movePointLayer);\n    this.map.removeLayer(this.baseOverlayerLayer);\n    this.map.removeLayer(this.hoverHighlightLayer);\n    this.map.removeOverlay(this.imagePreviewOverlay);\n    window.removeEventListener(\"resize\", this.resize());\n    this.mapillary.off(\"position\", this.mapillaryChanged);\n    this.mapillary.getComponent(\"sequence\").stop();\n  }\n};",{"version":3,"sources":["Mapillary.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div id=\"mapillary-container\" style=\"width: 100%; height: 100%;\">\n    <mapillary-image-preview\n      ref=\"imagePreview\"\n      :imageUrl=\"previewImageUrl\"\n      v-show=\"previewImageUrl.length > 1\"\n    />\n  </div>\n</template>\n<script>\nimport { Viewer } from \"mapillary-js\";\n\n//Ol imports\nimport OlVectorLayer from \"ol/layer/Vector\";\nimport OlVectorSource from \"ol/source/Vector\";\nimport OlPoint from \"ol/geom/Point\";\nimport OlVectorTileLayer from \"ol/layer/VectorTile\";\nimport OlVectorTileSource from \"ol/source/VectorTile\";\nimport OlOverlay from \"ol/Overlay\";\nimport { createXYZ } from \"ol/tilegrid\";\nimport { fromLonLat } from \"ol/proj\";\nimport OlFeature from \"ol/Feature\";\nimport MVT from \"ol/format/MVT\";\nimport { unByKey } from \"ol/Observable\";\nimport { transformExtent } from \"ol/proj\";\n// import { toLonLat } from \"ol/proj\";\n// import axios from \"axios\";\n\n//Style and map object import\nimport { mapillaryStyleDefs } from \"../../../style/OlStyleDefs\";\nimport { Mapable } from \"../../../mixins/Mapable\";\nimport { mapFields } from \"vuex-map-fields\";\n\n// Image preview component import (enabled on hover)\nimport MapillaryImagePreview from \"./controls/MapillaryImagePreview\";\n\nimport \"mapillary-js/dist/mapillary.css\";\nimport { debounce } from \"../../../utils/Helpers\";\n\nexport default {\n  name: \"app-mapillary\",\n  components: {\n    \"mapillary-image-preview\": MapillaryImagePreview\n  },\n  props: {\n    accessToken: {\n      type: String,\n      required: false,\n      default: \"MLY|4945732362162775|a3872ee8a2b737be51db110cdcdea3d4\"\n    },\n    baseLayerExtent: {\n      type: Array,\n      required: false\n    }\n  },\n  data() {\n    return {\n      // Preview Image url\n      previewImageUrl: \"\",\n      // Mapillary viewer\n      mapillary: null,\n      // Features\n      highlightFeature: null,\n      pointFeature: null,\n      // Layers\n      movePointLayer: null,\n      baseOverlayerLayer: null,\n      hoverHighlightLayer: null,\n      // Listener keys\n      mapClickListenerKey: null,\n      mapHoverListenerKey: null,\n      // Overlays\n      imagePreviewOverlay: null\n    };\n  },\n  mixins: [Mapable],\n  mounted() {\n    const container = document.getElementById(\"mapillary-container\");\n    const mapCenter = this.map.getView().getCenter();\n    const searchBounds = [\n      mapCenter[0] - 1500,\n      mapCenter[1] - 1500,\n      mapCenter[0] + 1500,\n      mapCenter[1] + 1500\n    ];\n    const extent = transformExtent(searchBounds, \"EPSG:3857\", \"EPSG:4326\");\n    fetch(\n      `https://graph.mapillary.com/images?fields=id,sequence&bbox=${extent.toString()}&limit=1`,\n      {\n        headers: { Authorization: \"OAuth \" + this.accessToken }\n      }\n    )\n      .then(response => response.json())\n      .then(response => {\n        this.isMapillaryBtnDisabled = false;\n        if (Array.isArray(response.data) && response.data.length > 0) {\n          const startImageId = response.data[0].id;\n          mapillaryStyleDefs.activeSequence = response.data[0].sequence;\n          console.log(response.data[0]);\n          this.mapillary = new Viewer({\n            accessToken: this.accessToken,\n            container: container,\n            imageId: startImageId,\n            component: { cover: false }\n          });\n          this.isMapillaryBtnDisabled = false;\n          window.addEventListener(\"resize\", this.resize());\n          this.createBaseOverlayLayer();\n          this.mapillary.on(\"image\", this.mapillaryChanged);\n          this.createFeatureOverlay();\n          this.createImagePreviewOverlay();\n          this.createMovePointLayer();\n          this.createHoverHighlightLayer();\n          this.addInteractions();\n          this.mapClickListenerKey = this.map.on(\"click\", this.onClick);\n          this.$nextTick(() => {\n            this.resize();\n          });\n        }\n      })\n      .catch(() => {\n        this.isMapillaryBtnDisabled = false;\n      });\n  },\n  methods: {\n    /**\n     * Overlay style\n     */\n    createFeatureOverlay() {\n      this.featureOverlay = new OlVectorLayer({\n        source: new OlVectorSource(),\n        map: this.map,\n        style: [\n          mapillaryStyleDefs.wifiStyle,\n          mapillaryStyleDefs.circleSolidStyle\n        ]\n      });\n    },\n\n    /**\n     * Image preview overlay\n     */\n\n    /**\n     * Show popup for the get info module.\n     */\n    createImagePreviewOverlay() {\n      this.imagePreviewOverlay = new OlOverlay({\n        element: this.$refs.imagePreview.$el,\n        autoPan: false,\n        autoPanMargin: 40,\n        autoPanAnimation: {\n          duration: 250\n        }\n      });\n      this.map.addOverlay(this.imagePreviewOverlay);\n    },\n\n    /**\n     * Radar point layer\n     */\n    createMovePointLayer() {\n      this.pointFeature = new OlFeature({\n        geometry: null\n      });\n      this.pointFeature.setStyle([\n        mapillaryStyleDefs.wifiStyle,\n        mapillaryStyleDefs.circleSolidStyle\n      ]);\n      this.movePointLayer = new OlVectorLayer({\n        zIndex: 10,\n        source: new OlVectorSource({ features: [this.pointFeature] })\n      });\n      this.map.addLayer(this.movePointLayer);\n    },\n\n    /**\n     * Overlay layer (sequences, images)\n     */\n    createBaseOverlayLayer() {\n      this.baseOverlayerLayer = new OlVectorTileLayer({\n        name: \"mapillaryBaseOverlay\",\n        renderMode: \"image\",\n        source: new OlVectorTileSource({\n          attributions:\n            \"© <a href='https://www.mapillary.com/'> <img src='./static/layer-styles/assets/icons/_backgroundLayers/mapillary.svg' width='12px' height='12px'> Mapillary</a>\",\n          format: new MVT(),\n          tileGrid: createXYZ({ maxZoom: 14 }),\n          tilePixelRatio: 16,\n          opacity: 0.7,\n          url: `https://tiles.mapillary.com/maps/vtp/mly1_computed_public/2/{z}/{x}/{y}?access_token=${this.accessToken}`\n        }),\n        style: mapillaryStyleDefs.baseOverlayStyle(this.map)\n      });\n      if (this.baseLayerExtent) {\n        this.baseOverlayerLayer.setExtent(this.baseLayerExtent);\n      }\n      this.map.addLayer(this.baseOverlayerLayer);\n    },\n\n    /**\n     * Create hover highlight layers\n     */\n    createHoverHighlightLayer() {\n      this.hoverHighlightLayer = new OlVectorLayer({\n        zIndex: 20,\n        name: \"mapillaryHighlightLayer\",\n        source: new OlVectorSource(),\n        style: mapillaryStyleDefs.highlightStyle\n      });\n      this.map.addLayer(this.hoverHighlightLayer);\n    },\n\n    /**\n     * Overlay layer interactions\n     */\n    async addInteractions() {\n      this.mapHoverListenerKey = this.map.on(\n        \"pointermove\",\n        debounce(async evt => {\n          let features = this.map.getFeaturesAtPixel(evt.pixel, {\n            layerFilter: candidate => {\n              if (candidate.get(\"name\") === \"mapillaryBaseOverlay\") {\n                return true;\n              }\n              return false;\n            }\n          });\n          features = features.filter(feature => {\n            return feature.get(\"layer\") === \"image\";\n          });\n          this.hoverHighlightLayer.getSource().clear();\n          if (features.length > 0 && features[0].get(\"id\")) {\n            this.imagePreviewOverlay.setPosition(\n              features[0].getFlatCoordinates()\n            );\n            const feature = new OlFeature({\n              geometry: new OlPoint(features[0].getFlatCoordinates())\n            });\n            feature.setProperties(features[0].getProperties());\n            this.hoverHighlightLayer.getSource().addFeature(feature);\n            this.map.getTarget().style.cursor = \"pointer\";\n            const imageRequestUrl = `https://graph.mapillary.com/${features[0].get(\n              \"id\"\n            )}?fields=id,captured_at,compass_angle,sequence,geometry,thumb_256_url`;\n            fetch(imageRequestUrl, {\n              headers: { Authorization: \"OAuth \" + this.accessToken }\n            })\n              .then(response => response.json())\n              .then(response => {\n                this.previewImageUrl = response.thumb_256_url;\n              });\n          } else {\n            this.previewImageUrl = \"\";\n            this.imagePreviewOverlay.setPosition(undefined);\n            this.map.getTarget().style.cursor = \"\";\n          }\n        }, 50)\n      );\n    },\n\n    /**\n     * Click event handler\n     */\n    onClick(evt) {\n      this.hoverHighlightLayer.getSource().clear();\n      const feature = this.map.forEachFeatureAtPixel(\n        evt.pixel,\n        function(feature) {\n          return feature;\n        },\n        {\n          layerFilter: layer => {\n            return layer === this.baseOverlayerLayer;\n          },\n          hitTolerance: 5\n        }\n      );\n\n      if (feature) {\n        if (feature.get(\"layer\") === \"sequence\") {\n          return;\n        }\n        var bearing = feature.get(\"compass_angle\");\n        this.mapillary.moveTo(feature.get(\"id\"));\n        this.featureOverlay.setStyle(\n          mapillaryStyleDefs.updateBearingStyle(bearing)\n        );\n        mapillaryStyleDefs.activeSequence = feature.get(\"sequence_id\");\n      } else {\n        return;\n      }\n      //Update layer\n      this.baseOverlayerLayer.changed();\n    },\n\n    /**\n     * Mapillary changed event handler\n     */\n    mapillaryChanged(evt) {\n      if (this.featureOverlay.getVisible()) {\n        this.featureOverlay.setVisible(false);\n      }\n      const image = evt.image;\n      const lonLat = new fromLonLat([image.lngLat.lng, image.lngLat.lat]);\n      this.map.getView().animate({\n        center: lonLat,\n        duration: 400\n      });\n      if (this.pointFeature.getGeometry() === null) {\n        this.pointFeature.setGeometry(new OlPoint(lonLat));\n      } else {\n        this.pointFeature.getGeometry().setCoordinates(lonLat);\n      }\n      this.pointFeature.setStyle(\n        mapillaryStyleDefs.updateBearingStyle(image.compassAngle)\n      );\n    },\n\n    /**\n     * Resize method\n     */\n    resize() {\n      this.mapillary.resize();\n    }\n  },\n  computed: {\n    ...mapFields(\"map\", {\n      isMapillaryBtnDisabled: \"isMapillaryBtnDisabled\",\n      isMapillaryButtonActive: \"isMapillaryButtonActive\"\n    })\n  },\n  destroyed() {\n    unByKey(this.mapClickListenerKey);\n    unByKey(this.mapHoverListenerKey);\n    this.map.removeLayer(this.movePointLayer);\n    this.map.removeLayer(this.baseOverlayerLayer);\n    this.map.removeLayer(this.hoverHighlightLayer);\n    this.map.removeOverlay(this.imagePreviewOverlay);\n    window.removeEventListener(\"resize\", this.resize());\n    this.mapillary.off(\"position\", this.mapillaryChanged);\n    this.mapillary.getComponent(\"sequence\").stop();\n  }\n};\n</script>\n<style lang=\"css\" scoped></style>\n"],"sourceRoot":"src/components/viewer/mapillary"}]}